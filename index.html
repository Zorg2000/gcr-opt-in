<!DOCTYPE html>
<html>
<head>
<title>Google Customer Reviews Opt-In</title>
</head>
<body>
<h1>Thank You for Your Order!</h1>
<p>Redirecting you back to your order status page...</p>

<!-- BEGIN GCR Opt-In Code -->
<!-- THIS IS THE CORRECTED LINE -->
<script src="apis.google.com" async defer></script> 
<script>
  function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results.replace(/\+/g, ' '));
  };

  window.onLoadCallback = function() {
    var orderId = getUrlParameter('orderid');
    var email = getUrlParameter('email');
    var deliveryDate = getUrlParameter('dd');
    var currency = getUrlParameter('currency');
    var returnUrl = getUrlParameter('returnurl'); // CAPTURE RETURN URL

    if (orderId && email && deliveryDate && currency && returnUrl) {
      window.gapi.load('surveyoptin', function() {
        window.gapi.surveyoptin.render({
          "merchant_id": 396091698,
          "order_id": orderId,
          "email": email,
          "delivery_country": "NZ",
          "estimated_delivery_date": deliveryDate,
          "opt_in_style": "CENTER_DIALOG"
        });

        // Redirect back to Shopify after a short delay (e.g., 3 seconds)
        setTimeout(function() {
          window.location.href = returnUrl;
        }, 3000); // Redirects after 3 seconds

      });
    } else {
      document.body.innerHTML = '<h1>Error</h1><p>Missing order details.</p>';
    }
  };
</script>
<!-- END GCR Opt-In Code -->

</body>
</html>
